version: '3.8'

services:
  app:
    image: python:3.13-slim
    environment:
      DEBUG: "True"
      SECRET_KEY: "django-insecure-5pq8*z#9@k2x!m$vn7&wj3-t+b4r6q*s8d1f2h4j5l7p9"
      ALLOWED_HOSTS: "localhost,127.0.0.1,0.0.0.0,69.62.89.102,instahunter.local,instahunter.example.com"
      CSRF_TRUSTED_ORIGINS: "https://69.62.89.102:2233,http://69.62.89.102:2233,http://localhost:2233,http://127.0.0.1:2233,https://instahunter.example.com,http://instahunter.local:2233"
      CSRF_COOKIE_SECURE: "False"
      SESSION_COOKIE_SECURE: "False"
      DATABASE_URL: "sqlite:///db.sqlite3"
      EVOLUTION_API_URL: "https://sua-api-evolution.com"
      EVOLUTION_API_KEY: "sua-chave-api-evolution"
      N8N_WEBHOOK_URL: "https://n8n.sumconnectia.tech/webhook/activeSender"
      PYTHONUNBUFFERED: "1"
      
    working_dir: /workspace/instahunter
    ports:
      - "2233:8000"
    volumes:
      - app_media:/workspace/instahunter/media
      - app_static:/workspace/instahunter/staticfiles
      - db_data:/workspace/instahunter
  
    command: >
      sh -c "
        apt-get update -qq &&
        apt-get install -y -qq git netcat-traditional build-essential pkg-config curl &&
        cd /workspace/instahunter &&
        if [ -d .git ]; then
          echo 'Atualizando repositório...' &&
          git reset --hard HEAD &&
          git pull origin main || git pull origin master;
        else
          echo 'Clonando repositório...' &&
          git init &&
          git remote add origin https://github.com/Fernando-Godinho/INSTAHUNTER-2.0.git &&
          git fetch origin main master &&
          git reset --hard origin/main || git reset --hard origin/master &&
          git branch -M main;
        fi &&
        echo 'Instalando dependências...' &&
        pip install -q -r requirements.txt &&
        pip install -q gunicorn whitenoise &&
        echo 'Executando migrações...' &&
        python manage.py migrate --noinput &&
        echo 'Coletando arquivos estáticos...' &&
        python manage.py collectstatic --noinput --clear &&
        echo 'Iniciando servidor...' &&
        gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 120 instahunter.wsgi:application
      "
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  app_media:
  app_static:
  db_data:
